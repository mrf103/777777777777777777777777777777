import React, { useState } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { base44 } from "@/api/base44Client";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { motion, AnimatePresence } from "framer-motion";
import {
  Shield,
  BookOpen,
  ArrowLeft,
  Loader2,
  AlertTriangle,
  CheckCircle,
  XCircle,
  Eye,
  Plus,
  Search,
  Filter,
  Trash2,
  Edit,
  FileWarning,
  ShieldCheck,
  ShieldAlert,
  BarChart3
} from "lucide-react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";

export default function ComplianceEngine() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const urlParams = new URLSearchParams(window.location.search);
  const manuscriptId = urlParams.get("id");

  const [selectedManuscript, setSelectedManuscript] = useState(null);
  const [scanning, setScanning] = useState(false);
  const [scanProgress, setScanProgress] = useState(0);
  const [scanResults, setScanResults] = useState(null);
  const [showRuleDialog, setShowRuleDialog] = useState(false);
  const [editingRule, setEditingRule] = useState(null);
  const [deleteRuleId, setDeleteRuleId] = useState(null);
  
  const [newRule, setNewRule] = useState({
    name: "",
    description: "",
    category: "religious",
    severity: "medium",
    keywords: "",
    is_active: true
  });

  const { data: manuscripts = [] } = useQuery({
    queryKey: ["manuscripts"],
    queryFn: () => base44.entities.Manuscript.list("-created_date"),
  });

  const { data: rules = [], isLoading: loadingRules } = useQuery({
    queryKey: ["compliance-rules"],
    queryFn: () => base44.entities.ComplianceRule.list(),
  });

  const { data: manuscript } = useQuery({
    queryKey: ["manuscript", manuscriptId],
    queryFn: () => base44.entities.Manuscript.filter({ id: manuscriptId }),
    enabled: !!manuscriptId,
    select: (data) => data[0],
  });

  React.useEffect(() => {
    if (manuscript) {
      setSelectedManuscript(manuscript);
    }
  }, [manuscript]);

  const createRuleMutation = useMutation({
    mutationFn: (data) => base44.entities.ComplianceRule.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["compliance-rules"] });
      setShowRuleDialog(false);
      resetNewRule();
    },
  });

  const updateRuleMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.ComplianceRule.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["compliance-rules"] });
      setShowRuleDialog(false);
      setEditingRule(null);
      resetNewRule();
    },
  });

  const deleteRuleMutation = useMutation({
    mutationFn: (id) => base44.entities.ComplianceRule.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["compliance-rules"] });
      setDeleteRuleId(null);
    },
  });

  const updateManuscriptMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.Manuscript.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["manuscripts"] });
    },
  });

  const resetNewRule = () => {
    setNewRule({
      name: "",
      description: "",
      category: "religious",
      severity: "medium",
      keywords: "",
      is_active: true
    });
  };

  const runComplianceScan = async () => {
    if (!selectedManuscript) return;
    
    setScanning(true);
    setScanProgress(0);
    setScanResults(null);
    
    const progressInterval = setInterval(() => {
      setScanProgress((prev) => Math.min(prev + 2, 90));
    }, 200);

    const activeRules = rules.filter(r => r.is_active);
    const allKeywords = activeRules.flatMap(r => r.keywords || []);
    
    const result = await base44.integrations.Core.InvokeLLM({
      prompt: `Ø£Ù†Øª Ù…Ø­Ø±Ùƒ Ø§Ù…ØªØ«Ø§Ù„ Ù…ØªØ®ØµØµ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠ. Ù‚Ù… Ø¨ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ ÙˆÙØ­ØµÙ‡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØ§Ù„ÙŠØ©:

Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯:
${activeRules.map(r => `- ${r.name}: ${r.description} (Ø§Ù„ÙØ¦Ø©: ${r.category}, Ø§Ù„Ø´Ø¯Ø©: ${r.severity})`).join('\n')}

Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ© Ù„Ù„ÙØ­Øµ:
${allKeywords.join(', ')}

Ø§Ù„Ù†Øµ Ù„Ù„ÙØ­Øµ:
${selectedManuscript.content?.substring(0, 15000) || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰"}

Ù‚Ø¯Ù… ØªÙ‚Ø±ÙŠØ±Ø§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹ ÙŠØªØ¶Ù…Ù†:
1. Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© (Ù…Ø¬Ø§Ø²/ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©/Ù…Ø±ÙÙˆØ¶)
2. Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ´ÙØ© Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ù‡Ø§
3. ØªÙˆØµÙŠØ§Øª Ù„Ù„ØªØµØ­ÙŠØ­
4. Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„`,
      response_json_schema: {
        type: "object",
        properties: {
          overall_status: { type: "string", enum: ["passed", "flagged", "rejected"] },
          compliance_score: { type: "number" },
          issues: {
            type: "array",
            items: {
              type: "object",
              properties: {
                rule_name: { type: "string" },
                severity: { type: "string" },
                category: { type: "string" },
                description: { type: "string" },
                context: { type: "string" },
                recommendation: { type: "string" }
              }
            }
          },
          summary: { type: "string" },
          recommendations: { type: "array", items: { type: "string" } }
        }
      }
    });
    
    clearInterval(progressInterval);
    setScanProgress(100);
    setScanResults(result);
    
    // Update manuscript compliance status
    updateManuscriptMutation.mutate({
      id: selectedManuscript.id,
      data: { compliance_status: result.overall_status }
    });
    
    setScanning(false);
  };

  const severityColors = {
    critical: "bg-red-100 text-red-700 border-red-200",
    high: "bg-orange-100 text-orange-700 border-orange-200",
    medium: "bg-yellow-100 text-yellow-700 border-yellow-200",
    low: "bg-blue-100 text-blue-700 border-blue-200",
  };

  const categoryLabels = {
    religious: "Ø¯ÙŠÙ†ÙŠ",
    political: "Ø³ÙŠØ§Ø³ÙŠ",
    social: "Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ",
    legal: "Ù‚Ø§Ù†ÙˆÙ†ÙŠ",
    cultural: "Ø«Ù‚Ø§ÙÙŠ",
  };

  const severityLabels = {
    critical: "Ø­Ø±Ø¬",
    high: "Ø¹Ø§Ù„ÙŠ",
    medium: "Ù…ØªÙˆØ³Ø·",
    low: "Ù…Ù†Ø®ÙØ¶",
  };

  return (
    <div className="p-8">
      <motion.div
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        className="mb-8"
      >
        <Button
          variant="ghost"
          onClick={() => navigate(createPageUrl("Dashboard"))}
          className="mb-4 gap-2"
        >
          <ArrowLeft className="w-4 h-4" />
          Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        </Button>
        <h1 className="text-3xl font-bold text-slate-800 flex items-center gap-3">
          <Shield className="w-8 h-8 text-[#2563eb]" />
          Ù…Ø­Ø±Ùƒ Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„
        </h1>
        <p className="text-slate-500 mt-1">ÙØ­Øµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ¶Ù…Ø§Ù† ØªÙˆØ§ÙÙ‚Ù‡ Ù…Ø¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø±Ù‚Ø§Ø¨ÙŠØ©</p>
      </motion.div>

      <Tabs defaultValue="scan" className="space-y-6">
        <TabsList className="bg-slate-100">
          <TabsTrigger value="scan" className="gap-2">
            <ShieldCheck className="w-4 h-4" />
            ÙØ­Øµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
          </TabsTrigger>
          <TabsTrigger value="rules" className="gap-2">
            <ShieldAlert className="w-4 h-4" />
            Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„
          </TabsTrigger>
        </TabsList>

        <TabsContent value="scan">
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {/* Manuscript Selection */}
            <div className="lg:col-span-2 space-y-6">
              <Card className="border-0 shadow-lg">
                <CardHeader>
                  <CardTitle>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø®Ø·ÙˆØ·Ø© Ù„Ù„ÙØ­Øµ</CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    {manuscripts.map((m) => (
                      <button
                        key={m.id}
                        onClick={() => {
                          setSelectedManuscript(m);
                          setScanResults(null);
                        }}
                        className={`flex items-center gap-3 p-4 rounded-xl border-2 transition-all text-right ${
                          selectedManuscript?.id === m.id
                            ? "border-[#2563eb] bg-blue-50"
                            : "border-slate-200 hover:border-slate-300"
                        }`}
                      >
                        <div className="w-10 h-14 bg-gradient-to-br from-[#1e3a5f] to-[#2563eb] rounded-lg flex items-center justify-center">
                          <BookOpen className="w-5 h-5 text-white" />
                        </div>
                        <div className="flex-1">
                          <h4 className="font-medium text-slate-800">{m.title}</h4>
                          <div className="flex items-center gap-2 mt-1">
                            <Badge
                              className={
                                m.compliance_status === "passed"
                                  ? "bg-emerald-100 text-emerald-700"
                                  : m.compliance_status === "flagged"
                                  ? "bg-red-100 text-red-700"
                                  : "bg-slate-100 text-slate-600"
                              }
                            >
                              {m.compliance_status === "passed"
                                ? "Ù…Ø¬Ø§Ø²"
                                : m.compliance_status === "flagged"
                                ? "ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©"
                                : "Ù„Ù… ÙŠÙØ­Øµ"}
                            </Badge>
                          </div>
                        </div>
                        {selectedManuscript?.id === m.id && (
                          <CheckCircle className="w-5 h-5 text-[#2563eb]" />
                        )}
                      </button>
                    ))}
                  </div>
                </CardContent>
              </Card>

              {/* Scan Results */}
              {scanResults && (
                <motion.div
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                >
                  <Card className="border-0 shadow-lg">
                    <CardHeader>
                      <CardTitle className="flex items-center justify-between">
                        <span className="flex items-center gap-2">
                          <BarChart3 className="w-5 h-5 text-[#2563eb]" />
                          Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­Øµ
                        </span>
                        <Badge
                          className={
                            scanResults.overall_status === "passed"
                              ? "bg-emerald-100 text-emerald-700"
                              : scanResults.overall_status === "flagged"
                              ? "bg-amber-100 text-amber-700"
                              : "bg-red-100 text-red-700"
                          }
                        >
                          {scanResults.overall_status === "passed"
                            ? "Ù…Ø¬Ø§Ø²"
                            : scanResults.overall_status === "flagged"
                            ? "ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©"
                            : "Ù…Ø±ÙÙˆØ¶"}
                        </Badge>
                      </CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-6">
                      {/* Score */}
                      <div className="bg-slate-50 rounded-xl p-6">
                        <div className="flex items-center justify-between mb-3">
                          <span className="font-medium text-slate-700">Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„</span>
                          <span className="text-2xl font-bold text-slate-800">
                            {scanResults.compliance_score}%
                          </span>
                        </div>
                        <Progress value={scanResults.compliance_score} className="h-3" />
                      </div>

                      {/* Summary */}
                      <div>
                        <h4 className="font-medium text-slate-700 mb-2">Ø§Ù„Ù…Ù„Ø®Øµ</h4>
                        <p className="text-slate-600 bg-slate-50 p-4 rounded-xl">
                          {scanResults.summary}
                        </p>
                      </div>

                      {/* Issues */}
                      {scanResults.issues?.length > 0 && (
                        <div>
                          <h4 className="font-medium text-slate-700 mb-3">
                            Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ´ÙØ© ({scanResults.issues.length})
                          </h4>
                          <div className="space-y-3">
                            {scanResults.issues.map((issue, i) => (
                              <div
                                key={i}
                                className={`p-4 rounded-xl border-2 ${
                                  severityColors[issue.severity]?.split(' ')[0] || 'bg-slate-50'
                                } border-opacity-50`}
                              >
                                <div className="flex items-start justify-between mb-2">
                                  <h5 className="font-medium">{issue.rule_name}</h5>
                                  <div className="flex gap-2">
                                    <Badge className={severityColors[issue.severity]}>
                                      {severityLabels[issue.severity]}
                                    </Badge>
                                    <Badge variant="outline">
                                      {categoryLabels[issue.category]}
                                    </Badge>
                                  </div>
                                </div>
                                <p className="text-sm text-slate-600 mb-2">{issue.description}</p>
                                {issue.context && (
                                  <p className="text-xs text-slate-500 bg-white/50 p-2 rounded mb-2">
                                    "{issue.context}"
                                  </p>
                                )}
                                {issue.recommendation && (
                                  <p className="text-sm text-emerald-700">
                                    ğŸ’¡ {issue.recommendation}
                                  </p>
                                )}
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* Recommendations */}
                      {scanResults.recommendations?.length > 0 && (
                        <div>
                          <h4 className="font-medium text-slate-700 mb-3">Ø§Ù„ØªÙˆØµÙŠØ§Øª</h4>
                          <ul className="space-y-2">
                            {scanResults.recommendations.map((rec, i) => (
                              <li key={i} className="flex items-start gap-2 text-slate-600">
                                <CheckCircle className="w-4 h-4 text-emerald-500 mt-1 shrink-0" />
                                {rec}
                              </li>
                            ))}
                          </ul>
                        </div>
                      )}
                    </CardContent>
                  </Card>
                </motion.div>
              )}
            </div>

            {/* Scan Controls */}
            <div className="space-y-6">
              <Card className="border-0 shadow-lg sticky top-8">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <ShieldCheck className="w-5 h-5 text-emerald-500" />
                    Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  {selectedManuscript && (
                    <div className="bg-slate-50 rounded-xl p-4">
                      <h4 className="font-medium text-slate-700">{selectedManuscript.title}</h4>
                      <p className="text-sm text-slate-500 mt-1">
                        {selectedManuscript.word_count?.toLocaleString()} ÙƒÙ„Ù…Ø©
                      </p>
                    </div>
                  )}

                  <div className="bg-blue-50 rounded-xl p-4">
                    <h4 className="text-sm font-medium text-blue-800 mb-2">Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù†Ø´Ø·Ø©</h4>
                    <p className="text-2xl font-bold text-blue-700">
                      {rules.filter(r => r.is_active).length}
                    </p>
                  </div>

                  {scanning && (
                    <div className="space-y-2">
                      <div className="flex justify-between text-sm">
                        <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</span>
                        <span>{Math.round(scanProgress)}%</span>
                      </div>
                      <Progress value={scanProgress} className="h-2" />
                    </div>
                  )}

                  <Button
                    onClick={runComplianceScan}
                    disabled={!selectedManuscript || scanning}
                    className="w-full bg-gradient-to-l from-[#1e3a5f] to-[#2563eb] gap-2"
                  >
                    {scanning ? (
                      <Loader2 className="w-4 h-4 animate-spin" />
                    ) : (
                      <Shield className="w-4 h-4" />
                    )}
                    {scanning ? "Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ..." : "Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ"}
                  </Button>
                </CardContent>
              </Card>
            </div>
          </div>
        </TabsContent>

        <TabsContent value="rules">
          <Card className="border-0 shadow-lg">
            <CardHeader className="flex flex-row items-center justify-between">
              <CardTitle>Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„</CardTitle>
              <Dialog open={showRuleDialog} onOpenChange={setShowRuleDialog}>
                <DialogTrigger asChild>
                  <Button className="gap-2" onClick={() => { setEditingRule(null); resetNewRule(); }}>
                    <Plus className="w-4 h-4" />
                    Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¹Ø¯Ø©
                  </Button>
                </DialogTrigger>
                <DialogContent className="max-w-lg">
                  <DialogHeader>
                    <DialogTitle>
                      {editingRule ? "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©" : "Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¹Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©"}
                    </DialogTitle>
                  </DialogHeader>
                  <div className="space-y-4 mt-4">
                    <div className="space-y-2">
                      <Label>Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©</Label>
                      <Input
                        value={newRule.name}
                        onChange={(e) => setNewRule({ ...newRule, name: e.target.value })}
                        placeholder="Ù…Ø«Ø§Ù„: ÙØ­Øµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯ÙŠÙ†ÙŠ"
                      />
                    </div>
                    <div className="space-y-2">
                      <Label>Ø§Ù„ÙˆØµÙ</Label>
                      <Textarea
                        value={newRule.description}
                        onChange={(e) => setNewRule({ ...newRule, description: e.target.value })}
                        placeholder="ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ù‚Ø§Ø¹Ø¯Ø©..."
                        rows={3}
                      />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div className="space-y-2">
                        <Label>Ø§Ù„ÙØ¦Ø©</Label>
                        <Select
                          value={newRule.category}
                          onValueChange={(value) => setNewRule({ ...newRule, category: value })}
                        >
                          <SelectTrigger>
                            <SelectValue />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="religious">Ø¯ÙŠÙ†ÙŠ</SelectItem>
                            <SelectItem value="political">Ø³ÙŠØ§Ø³ÙŠ</SelectItem>
                            <SelectItem value="social">Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ</SelectItem>
                            <SelectItem value="legal">Ù‚Ø§Ù†ÙˆÙ†ÙŠ</SelectItem>
                            <SelectItem value="cultural">Ø«Ù‚Ø§ÙÙŠ</SelectItem>
                          </SelectContent>
                        </Select>
                      </div>
                      <div className="space-y-2">
                        <Label>Ø§Ù„Ø´Ø¯Ø©</Label>
                        <Select
                          value={newRule.severity}
                          onValueChange={(value) => setNewRule({ ...newRule, severity: value })}
                        >
                          <SelectTrigger>
                            <SelectValue />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="critical">Ø­Ø±Ø¬</SelectItem>
                            <SelectItem value="high">Ø¹Ø§Ù„ÙŠ</SelectItem>
                            <SelectItem value="medium">Ù…ØªÙˆØ³Ø·</SelectItem>
                            <SelectItem value="low">Ù…Ù†Ø®ÙØ¶</SelectItem>
                          </SelectContent>
                        </Select>
                      </div>
                    </div>
                    <div className="space-y-2">
                      <Label>Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ© (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„)</Label>
                      <Textarea
                        value={newRule.keywords}
                        onChange={(e) => setNewRule({ ...newRule, keywords: e.target.value })}
                        placeholder="ÙƒÙ„Ù…Ø©1ØŒ ÙƒÙ„Ù…Ø©2ØŒ ÙƒÙ„Ù…Ø©3..."
                        rows={2}
                      />
                    </div>
                    <Button
                      onClick={() => {
                        const data = {
                          ...newRule,
                          keywords: newRule.keywords.split('ØŒ').map(k => k.trim()).filter(Boolean)
                        };
                        if (editingRule) {
                          updateRuleMutation.mutate({ id: editingRule.id, data });
                        } else {
                          createRuleMutation.mutate(data);
                        }
                      }}
                      disabled={!newRule.name || createRuleMutation.isPending || updateRuleMutation.isPending}
                      className="w-full"
                    >
                      {(createRuleMutation.isPending || updateRuleMutation.isPending) ? (
                        <Loader2 className="w-4 h-4 animate-spin" />
                      ) : editingRule ? (
                        "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª"
                      ) : (
                        "Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©"
                      )}
                    </Button>
                  </div>
                </DialogContent>
              </Dialog>
            </CardHeader>
            <CardContent>
              {loadingRules ? (
                <div className="space-y-3">
                  {[1, 2, 3].map((i) => (
                    <div key={i} className="h-20 bg-slate-100 rounded-xl animate-pulse" />
                  ))}
                </div>
              ) : rules.length === 0 ? (
                <div className="text-center py-12">
                  <ShieldAlert className="w-12 h-12 text-slate-300 mx-auto mb-4" />
                  <p className="text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù…ØªØ«Ø§Ù„</p>
                  <p className="text-sm text-slate-400">Ø£Ø¶Ù Ù‚ÙˆØ§Ø¹Ø¯ Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¨Ø¯Ø¡ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</p>
                </div>
              ) : (
                <div className="space-y-3">
                  {rules.map((rule) => (
                    <div
                      key={rule.id}
                      className={`p-4 rounded-xl border-2 transition-all ${
                        rule.is_active ? "border-slate-200" : "border-slate-100 opacity-60"
                      }`}
                    >
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-1">
                            <h4 className="font-medium text-slate-800">{rule.name}</h4>
                            <Badge className={severityColors[rule.severity]}>
                              {severityLabels[rule.severity]}
                            </Badge>
                            <Badge variant="outline">{categoryLabels[rule.category]}</Badge>
                          </div>
                          <p className="text-sm text-slate-600">{rule.description}</p>
                          {rule.keywords?.length > 0 && (
                            <div className="flex flex-wrap gap-1 mt-2">
                              {rule.keywords.slice(0, 5).map((kw, i) => (
                                <span key={i} className="text-xs bg-slate-100 px-2 py-1 rounded">
                                  {kw}
                                </span>
                              ))}
                              {rule.keywords.length > 5 && (
                                <span className="text-xs text-slate-400">
                                  +{rule.keywords.length - 5}
                                </span>
                              )}
                            </div>
                          )}
                        </div>
                        <div className="flex items-center gap-2">
                          <Button
                            variant="ghost"
                            size="icon"
                            onClick={() => {
                              setEditingRule(rule);
                              setNewRule({
                                name: rule.name,
                                description: rule.description || "",
                                category: rule.category,
                                severity: rule.severity,
                                keywords: rule.keywords?.join('ØŒ ') || "",
                                is_active: rule.is_active
                              });
                              setShowRuleDialog(true);
                            }}
                          >
                            <Edit className="w-4 h-4" />
                          </Button>
                          <Button
                            variant="ghost"
                            size="icon"
                            className="text-red-500"
                            onClick={() => setDeleteRuleId(rule.id)}
                          >
                            <Trash2 className="w-4 h-4" />
                          </Button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>

      {/* Delete Rule Dialog */}
      <AlertDialog open={!!deleteRuleId} onOpenChange={() => setDeleteRuleId(null)}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©</AlertDialogTitle>
            <AlertDialogDescription>
              Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter className="gap-2">
            <AlertDialogCancel>Ø¥Ù„ØºØ§Ø¡</AlertDialogCancel>
            <AlertDialogAction
              onClick={() => deleteRuleMutation.mutate(deleteRuleId)}
              className="bg-red-600 hover:bg-red-700"
            >
              Ø­Ø°Ù
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}