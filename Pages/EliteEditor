import React, { useState, useEffect } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { base44 } from "@/api/base44Client";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { motion } from "framer-motion";
import {
  Sparkles,
  BookOpen,
  Save,
  ArrowLeft,
  Loader2,
  Wand2,
  MessageSquare,
  TrendingUp,
  BarChart3,
  FileText,
  Lightbulb,
  RefreshCw,
  ChevronDown,
  ChevronUp,
  Check
} from "lucide-react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from "@/components/ui/collapsible";
import NarrativeArcChart from "@/components/editor/NarrativeArcChart";
import EditingSuggestions from "@/components/editor/EditingSuggestions";

export default function EliteEditor() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const urlParams = new URLSearchParams(window.location.search);
  const manuscriptId = urlParams.get("id");

  const [selectedChapter, setSelectedChapter] = useState(null);
  const [editedContent, setEditedContent] = useState("");
  const [analyzing, setAnalyzing] = useState(false);
  const [suggestions, setSuggestions] = useState([]);
  const [narrativeArc, setNarrativeArc] = useState(null);
  const [styleAnalysis, setStyleAnalysis] = useState(null);

  const { data: manuscripts = [] } = useQuery({
    queryKey: ["manuscripts"],
    queryFn: () => base44.entities.Manuscript.list("-created_date"),
  });

  const { data: manuscript, isLoading } = useQuery({
    queryKey: ["manuscript", manuscriptId],
    queryFn: () => base44.entities.Manuscript.filter({ id: manuscriptId }),
    enabled: !!manuscriptId,
    select: (data) => data[0],
  });

  const updateMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.Manuscript.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["manuscript", manuscriptId] });
    },
  });

  useEffect(() => {
    if (manuscript?.chapters?.length > 0 && !selectedChapter) {
      setSelectedChapter(manuscript.chapters[0]);
      setEditedContent(manuscript.chapters[0].content || "");
    } else if (manuscript && !selectedChapter) {
      setEditedContent(manuscript.content || "");
    }
  }, [manuscript]);

  useEffect(() => {
    if (selectedChapter) {
      setEditedContent(selectedChapter.content || "");
    }
  }, [selectedChapter]);

  const analyzeContent = async () => {
    setAnalyzing(true);
    
    const contentToAnalyze = selectedChapter ? editedContent : manuscript?.content || editedContent;
    
    const result = await base44.integrations.Core.InvokeLLM({
      prompt: `قم بتحليل النص التالي وقدم تقريراً شاملاً يتضمن:
1. تحليل القوس السردي (المقدمة، الحبكة الصاعدة، الذروة، الحبكة الهابطة، النهاية) بنسب مئوية
2. تحليل الأسلوب (نوع السرد، درجة التعقيد، التشويق، العاطفة)
3. اقتراحات للتحسين (5 اقتراحات على الأقل)
4. نقاط القوة والضعف

النص:
${contentToAnalyze?.substring(0, 10000)}`,
      response_json_schema: {
        type: "object",
        properties: {
          narrative_arc: {
            type: "object",
            properties: {
              exposition: { type: "number" },
              rising_action: { type: "number" },
              climax: { type: "number" },
              falling_action: { type: "number" },
              resolution: { type: "number" }
            }
          },
          style_analysis: {
            type: "object",
            properties: {
              narration_type: { type: "string" },
              complexity: { type: "number" },
              suspense: { type: "number" },
              emotion: { type: "number" },
              pacing: { type: "number" }
            }
          },
          suggestions: {
            type: "array",
            items: {
              type: "object",
              properties: {
                type: { type: "string" },
                title: { type: "string" },
                description: { type: "string" },
                priority: { type: "string" }
              }
            }
          },
          strengths: { type: "array", items: { type: "string" } },
          weaknesses: { type: "array", items: { type: "string" } }
        }
      }
    });
    
    setNarrativeArc(result.narrative_arc);
    setStyleAnalysis(result.style_analysis);
    setSuggestions(result.suggestions || []);
    setAnalyzing(false);
  };

  const improveText = async () => {
    setAnalyzing(true);
    
    const result = await base44.integrations.Core.InvokeLLM({
      prompt: `قم بتحسين النص التالي من حيث الأسلوب واللغة والتعبير، مع الحفاظ على المعنى الأصلي:

${editedContent?.substring(0, 5000)}`,
      response_json_schema: {
        type: "object",
        properties: {
          improved_text: { type: "string" },
          changes_made: { type: "array", items: { type: "string" } }
        }
      }
    });
    
    if (result.improved_text) {
      setEditedContent(result.improved_text);
    }
    setAnalyzing(false);
  };

  const saveChanges = async () => {
    if (!manuscript) return;
    
    let updateData = {};
    
    if (selectedChapter) {
      const updatedChapters = manuscript.chapters.map((ch) =>
        ch.id === selectedChapter.id ? { ...ch, content: editedContent } : ch
      );
      updateData = { chapters: updatedChapters };
    } else {
      updateData = { content: editedContent };
    }
    
    if (narrativeArc) {
      updateData.narrative_arc = narrativeArc;
    }
    
    updateMutation.mutate({ id: manuscript.id, data: updateData });
  };

  if (!manuscriptId) {
    return (
      <div className="p-8">
        <motion.div
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          className="mb-8"
        >
          <h1 className="text-3xl font-bold text-slate-800 flex items-center gap-3">
            <Sparkles className="w-8 h-8 text-[#c9a227]" />
            المحرر النخبة
          </h1>
          <p className="text-slate-500 mt-1">اختر مخطوطة للبدء في التحرير الذكي</p>
        </motion.div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {manuscripts.map((m) => (
            <Card
              key={m.id}
              className="border-0 shadow-lg hover:shadow-xl transition-all cursor-pointer"
              onClick={() => navigate(createPageUrl(`EliteEditor?id=${m.id}`))}
            >
              <CardContent className="p-6">
                <div className="flex items-start gap-4">
                  <div className="w-12 h-16 bg-gradient-to-br from-[#1e3a5f] to-[#2563eb] rounded-lg flex items-center justify-center">
                    <BookOpen className="w-6 h-6 text-white" />
                  </div>
                  <div className="flex-1">
                    <h3 className="font-semibold text-slate-800">{m.title}</h3>
                    <p className="text-sm text-slate-500">{m.author}</p>
                    <p className="text-sm text-slate-400 mt-2">
                      {m.word_count?.toLocaleString()} كلمة
                    </p>
                  </div>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      </div>
    );
  }

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-screen">
        <Loader2 className="w-8 h-8 animate-spin text-[#2563eb]" />
      </div>
    );
  }

  return (
    <div className="h-screen flex flex-col">
      {/* Header */}
      <div className="p-4 border-b bg-white/80 backdrop-blur-sm">
 