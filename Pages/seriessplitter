import React, { useState } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { base44 } from "@/api/base44Client";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { motion } from "framer-motion";
import {
  Layers,
  BookOpen,
  ArrowLeft,
  Loader2,
  Sparkles,
  Scissors,
  CheckCircle,
  AlertCircle,
  ChevronRight
} from "lucide-react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Slider } from "@/components/ui/slider";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Progress } from "@/components/ui/progress";

export default function SeriesSplitter() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  
  const [selectedManuscript, setSelectedManuscript] = useState(null);
  const [splitMethod, setSplitMethod] = useState("chapters");
  const [targetParts, setTargetParts] = useState(3);
  const [targetWordCount, setTargetWordCount] = useState(30000);
  const [splitting, setSplitting] = useState(false);
  const [splitProgress, setSplitProgress] = useState(0);
  const [splitResult, setSplitResult] = useState(null);

  const { data: manuscripts = [], isLoading } = useQuery({
    queryKey: ["manuscripts"],
    queryFn: () => base44.entities.Manuscript.list("-created_date"),
  });

  const createMutation = useMutation({
    mutationFn: (data) => base44.entities.Manuscript.create(data),
  });

  const largeManustrips = manuscripts.filter((m) => (m.word_count || 0) > 20000);

  const splitManuscript = async () => {
    if (!selectedManuscript) return;
    
    setSplitting(true);
    setSplitProgress(0);
    setSplitResult(null);
    
    const progressInterval = setInterval(() => {
      setSplitProgress((prev) => Math.min(prev + 3, 85));
    }, 300);

    // Use AI to analyze and suggest split points
    const result = await base44.integrations.Core.InvokeLLM({
      prompt: `أنت محرر كتب محترف. قم بتحليل المخطوطة التالية واقترح نقاط تقسيم ذكية للسلسلة.

معلومات المخطوطة:
- العنوان: ${selectedManuscript.title}
- عدد الكلمات: ${selectedManuscript.word_count}
- عدد الفصول: ${selectedManuscript.chapters?.length || 0}

طريقة التقسيم المطلوبة: ${splitMethod === "chapters" ? "حسب الفصول" : splitMethod === "parts" ? `${targetParts} أجزاء` : `حسب عدد الكلمات (${targetWordCount} كلمة لكل جزء)`}

محتوى المخطوطة (مختصر):
${selectedManuscript.content?.substring(0, 8000) || "لا يوجد محتوى"}

قم بتقديم اقتراحات للتقسيم تشمل:
1. عناوين مقترحة لكل جزء
2. نقاط التقسيم المنطقية
3. ملخص مختصر لكل جزء`,
      response_json_schema: {
        type: "object",
        properties: {
          suggested_parts: {
            type: "array",
            items: {
              type: "object",
              properties: {
                title: { type: "string" },
                subtitle: { type: "string" },
                summary: { type: "string" },
                start_chapter: { type: "number" },
                end_chapter: { type: "number" },
                estimated_words: { type: "number" }
              }
            }
          },
          split_reasoning: { type: "string" }
        }
      }
    });
    
    clearInterval(progressInterval);
    setSplitProgress(100);
    
    setSplitResult(result);
    setSplitting(false);
  };

  const createSplitBooks = async () => {
    if (!splitResult?.suggested_parts) return;
    
    setSplitting(true);
    
    for (let i = 0; i < splitResult.suggested_parts.length; i++) {
      const part = splitResult.suggested_parts[i];
      
      // Get chapters for this part
      const partChapters = selectedManuscript.chapters?.slice(
        part.start_chapter - 1,
        part.end_chapter
      ) || [];
      
      const partContent = partChapters.map((c) => c.content).join("\n\n") ||
        selectedManuscript.content?.substring(
          Math.floor((selectedManuscript.content.length / splitResult.suggested_parts.length) * i),
          Math.floor((selectedManuscript.content.length / splitResult.suggested_parts.length) * (i + 1))
        );
      
      await createMutation.mutateAsync({
        title: part.title,
        author: selectedManuscript.author,
        genre: selectedManuscript.genre,
        language: selectedManuscript.language,
        direction: selectedManuscript.direction,
        content: partContent,
        chapters: partChapters.map((ch, idx) => ({
          ...ch,
          id: `split-${i}-${idx}`,
          order: idx
        })),
        word_count: part.estimated_words,
        page_count: Math.ceil(part.estimated_words / 250),
        status: "draft",
        compliance_status: "pending"
      });
      
      setSplitProgress(((i + 1) / splitResult.suggested_parts.length) * 100);
    }
    
    queryClient.invalidateQueries({ queryKey: ["manuscripts"] });
    setSplitting(false);
    navigate(createPageUrl("Manuscripts"));
  };

  return (
    <div className="p-8">
      <motion.div
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        className="mb-8"
      >
        <Button
          variant="ghost"
          onClick={() => navigate(createPageUrl("Dashboard"))}
          className="mb-4 gap-2"
        >
          <ArrowLeft className="w-4 h-4" />
          العودة للوحة التحكم
        </Button>
        <h1 className="text-3xl font-bold text-slate-800 flex items-center gap-3">
          <Layers className="w-8 h-8 text-[#2563eb]" />
          تقسيم السلاسل
        </h1>
        <p className="text-slate-500 mt-1">قسّم مخطوطة ضخمة إلى سلسلة من الكتب بذكاء سياقي</p>
      </motion.div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        {/* Manuscript Selection */}
        <div className="lg:col-span-2 space-y-6">
          <Card className="border-0 shadow-lg">
            <CardHeader>
              <CardTitle>اختر المخطوطة</CardTitle>
            </CardHeader>
            <CardContent>
              {isLoading ? (
                <div className="space-y-3">
                  {[1, 2, 3].map((i) => (
                    <div key={i} className="h-20 bg-slate-100 rounded-xl animate-pulse" />
                  ))}
                </div>
              ) : largeManustrips.length === 0 ? (
                <div className="text-center py-12 bg-slate-50 rounded-xl">
                  <AlertCircle className="w-12 h-12 text-slate-300 mx-auto mb-4" />
                  <p className="text-slate-500">لا توجد مخطوطات ضخمة للتقسيم</p>
                  <p className="text-sm text-slate-400 mt-1">يجب أن تكون المخطوطة أكثر من 20,000 كلمة</p>
                </div>
              ) : (
                <div className="space-y-3">
                  {largeManustrips.map((manuscript) => (
                    <button
                      key={manuscript.id}
                      onClick={() => {
                        setSelectedManuscript(manuscript);
                        setSplitResult(null);
                      }}
                      className={`w-full flex items-center gap-4 p-4 rounded-xl border-2 transition-all text-right ${
                        selectedManuscript?.id === manuscript.id
                          ? "border-[#2563eb] bg-blue-50"
                          : "border-slate-200 hover:border-slate-300"
                      }`}
                    >
                      <div className="w-12 h-16 bg-gradient-to-br from-[#1e3a5f] to-[#2563eb] rounded-lg flex items-center justify-center">
                        <BookOpen className="w-6 h-6 text-white" />
                      </div>
                      <div className="flex-1">
                        <h4 className="font-semibold text-slate-800">{manuscript.title}</h4>
                        <p className="text-sm text-slate-500">{manuscript.author}</p>
                        <div className="flex gap-3 mt-2">
                          <Badge variant="outline">
                            {manuscript.word_count?.toLocaleString()} كلمة
                          </Badge>
                          <Badge variant="outline">
                            {manuscript.page_count} صفحة
                          </Badge>
                          <Badge variant="outline">
                            {manuscript.chapters?.length || 0} فصل
                          </Badge>
                        </div>
                      </div>
                      {selectedManuscript?.id === manuscript.id && (
                        <CheckCircle className="w-6 h-6 text-[#2563eb]" />
                      )}
                    </button>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>

          {/* Split Result */}
          {splitResult && (
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
            >
              <Card className="border-0 shadow-lg border-t-4 border-t-[#c9a227]">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <Sparkles className="w-5 h-5 text-[#c9a227]" />
                    نتائج التحليل
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-6">
                  <p className="text-slate-600 bg-slate-50 p-4 rounded-xl">
                    {splitResult.split_reasoning}
                  </p>
                  
                  <div className="space-y-4">
                    <h4 className="font-semibold text-slate-700">الأجزاء المقترحة:</h4>
                    {splitResult.suggested_parts?.map((part, i) => (
                      <div
                        key={i}
                        className="p-4 bg-gradient-to-l from-blue-50 to-white rounded-xl border border-blue-200"
                      >
                        <div className="flex items-start justify-between">
                          <div>
                            <Badge className="mb-2 bg-[#2563eb]">الجزء {i + 1}</Badge>
                            <h5 className="font-semibold text-slate-800">{part.title}</h5>
                            {part.subtitle && (
                              <p className="text-sm text-slate-600">{part.subtitle}</p>
                            )}
                          </div>
                          <div className="text-left text-sm text-slate-500">
                            <p>~{part.estimated_words?.toLocaleString()} كلمة</p>
                            <p>الفصول {part.start_chapter} - {part.end_chapter}</p>
                          </div>
                        </div>
                        <p className="text-sm text-slate-600 mt-3">{part.summary}</p>
                      </div>
                    ))}
                  </div>
                  
                  <Button
                    onClick={createSplitBooks}
                    disabled={splitting}
                    className="w-full bg-gradient-to-l from-[#1e3a5f] to-[#2563eb] gap-2"
                  >
                    {splitting ? (
                      <Loader2 className="w-4 h-4 animate-spin" />
                    ) : (
                      <CheckCircle className="w-4 h-4" />
                    )}
                    إنشاء الكتب المقسمة
                  </Button>
                </CardContent>
              </Card>
            </motion.div>
          )}
        </div>

        {/* Split Settings */}
        <div className="space-y-6">
          <Card className="border-0 shadow-lg sticky top-8">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Scissors className="w-5 h-5 text-[#2563eb]" />
                إعدادات التقسيم
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-6">
              <div className="space-y-4">
                <Label>طريقة التقسيم</Label>
                <RadioGroup value={splitMethod} onValueChange={setSplitMethod}>
                  <div className="flex items-center space-x-2 space-x-reverse">
                    <RadioGroupItem value="chapters" id="chapters" />
                    <Label htmlFor="chapters" className="cursor-pointer">
                      تقسيم ذكي حسب الفصول
                    </Label>
                  </div>
                  <div className="flex items-center space-x-2 space-x-reverse">
                    <RadioGroupItem value="parts" id="parts" />
                    <Label htmlFor="parts" className="cursor-pointer">
                      تقسيم لعدد أجزاء محدد
                    </Label>
                  </div>
                  <div className="flex items-center space-x-2 space-x-reverse">
                    <RadioGroupItem value="words" id="words" />
                    <Label htmlFor="words" className="cursor-pointer">
                      تقسيم حسب عدد الكلمات
                    </Label>
                  </div>
                </RadioGroup>
              </div>

              {splitMethod === "parts" && (
                <div className="space-y-3">
                  <Label>عدد الأجزاء: {targetParts}</Label>
                  <Slider
                    value={[targetParts]}
                    onValueChange={([v]) => setTargetParts(v)}
                    min={2}
                    max={10}
                    step={1}
                  />
                </div>
              )}

              {splitMethod === "words" && (
                <div className="space-y-3">
                  <Label>عدد الكلمات لكل جزء: {targetWordCount.toLocaleString()}</Label>
                  <Slider
                    value={[targetWordCount]}
                    onValueChange={([v]) => setTargetWordCount(v)}
                    min={10000}
                    max={100000}
                    step={5000}
                  />
                </div>
              )}

              {selectedManuscript && (
                <div className="bg-slate-50 rounded-xl p-4 space-y-3">
                  <h4 className="font-medium text-slate-700">المخطوطة المختارة</h4>
                  <p className="text-sm text-slate-800">{selectedManuscript.title}</p>
                  <div className="space-y-2 text-sm">
                    <div className="flex justify-between">
                      <span className="text-slate-500">عدد الكلمات</span>
                      <span className="font-medium">
                        {selectedManuscript.word_count?.toLocaleString()}
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-slate-500">عدد الفصول</span>
                      <span className="font-medium">
                        {selectedManuscript.chapters?.length || 0}
                      </span>
                    </div>
                  </div>
                </div>
              )}

              {splitting && (
                <div className="space-y-2">
                  <div className="flex justify-between text-sm">
                    <span>جاري التحليل...</span>
                    <span>{Math.round(splitProgress)}%</span>
                  </div>
                  <Progress value={splitProgress} className="h-2" />
                </div>
              )}

              <Button
                onClick={splitManuscript}
                disabled={!selectedManuscript || splitting}
                className="w-full bg-gradient-to-l from-[#1e3a5f] to-[#2563eb] gap-2"
              >
                {splitting ? (
                  <Loader2 className="w-4 h-4 animate-spin" />
                ) : (
                  <Sparkles className="w-4 h-4" />
                )}
                تحليل وتقسيم
              </Button>
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  );
}