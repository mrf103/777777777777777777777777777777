import React, { useState, useCallback } from "react";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { db } from "@/api/supabaseClient";
import FileService from "@/api/fileService";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { motion, AnimatePresence } from "framer-motion";
import {
  Upload as UploadIcon,
  FileText,
  X,
  Check,
  Loader2,
  BookOpen,
  User,
  Tag,
  Globe,
  ArrowLeft,
  Sparkles,
  AlertCircle,
  CheckCircle2
} from "lucide-react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Progress } from "@/components/ui/progress";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { validateFile, FileValidationAlert } from "@/components/upload/FileValidator";
import { analyzeAndCleanText, quickFileAnalysis } from "@/components/upload/TextAnalyzerEnhanced";
import { validatePublishingStandards, generatePublishingReport } from "@/components/upload/PublishingStandards";
import { ProcessingLogger } from "@/components/upload/ProcessingLogger";
import { LiveProgressIndicator } from "@/components/upload/LiveProgressIndicator";
import { useChunkProcessor } from "@/hooks/useChunkProcessor";
import { useProgressTracker } from "@/hooks/useProgressTracker";
import { wordCount } from "@/utils/nlp/arabicTokenizer";

export default function Upload() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  
  const [file, setFile] = useState(null);
  const [fileValidation, setFileValidation] = useState(null);
  const [uploading, setUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState(0);
  const [processing, setProcessing] = useState(false);
  const [processingStage, setProcessingStage] = useState("");
  const [quickAnalysis, setQuickAnalysis] = useState(null);
  const [formData, setFormData] = useState({
    title: "",
    author: "",
    genre: "",
    language: "ar",
    direction: "rtl",
  });
  const [extractedData, setExtractedData] = useState(null);
  const [analysisResults, setAnalysisResults] = useState(null);
  const [publishingReport, setPublishingReport] = useState(null);
  const [processingLog, setProcessingLog] = useState(null);
  const [isLargeFile, setIsLargeFile] = useState(false);
  
  // Initialize Progress Tracker
  const progressTracker = useProgressTracker();
  
  // Initialize ChunkProcessor hook
  const { processText, processing: chunkProcessing, progress: chunkProgress } = useChunkProcessor({
    maxChunkSize: 10000,
    useWebWorker: true
  });

  const handleFileDrop = useCallback((e) => {
    e.preventDefault();
    const droppedFile = e.dataTransfer?.files[0] || e.target.files[0];
    if (droppedFile) {
      const validation = validateFile(droppedFile);
      setFileValidation(validation);
      if (validation.valid) {
        setFile(droppedFile);
      } else {
        setFile(null);
      }
    }
  }, []);

  const handleDragOver = (e) => {
    e.preventDefault();
  };

  const createManuscriptMutation = useMutation({
    mutationFn: (data) => db.manuscripts.create(data),
    onSuccess: (data) => {
      queryClient.invalidateQueries({ queryKey: ["manuscripts"] });
      navigate(createPageUrl(`Manuscripts?id=${data.id}`));
    },
  });

  const processFile = async () => {
    if (!file || !fileValidation?.valid) return;
    
    const logger = progressTracker.createLogger();
    progressTracker.start();
    
    try {
      // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
      progressTracker.updateStage('file_upload', { 
        fileName: file.name, 
        fileSize: `${(file.size / 1024 / 1024).toFixed(2)} MB` 
      });
      
      setUploading(true);
      setUploadProgress(0);
      setProcessingStage("Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù...");
      
      const progressInterval = setInterval(() => {
        const newProgress = Math.min(uploadProgress + 10, 90);
        setUploadProgress(newProgress);
        progressTracker.updateProgress(newProgress * 0.15); // 15% Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚Ø¯Ù…
      }, 200);
      
      const { file_url } = await FileService.uploadFile(file);
      
      clearInterval(progressInterval);
      setUploadProgress(100);
      progressTracker.updateProgress(15); // Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§ÙƒØªÙ…Ù„
      setUploading(false);
      setProcessing(true);
      
      // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ
      progressTracker.updateStage('text_extraction', { stage: 'extracting' });
      setProcessingStage("Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ù…Ù„Ù...");
      
      const extractResult = await FileService.extractDataFromFile(file);
      
      if (extractResult.status !== "success" || !extractResult.output?.raw_content) {
        throw new Error("ÙØ´Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ù…Ù„Ù");
      }
      
      const rawContent = extractResult.output.raw_content;
      const contentWordCount = wordCount(rawContent);
      progressTracker.updateProgress(25);
      progressTracker.updateStageData({ 
        wordCount: contentWordCount,
        extracted: true
      });
      
      // ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
      const isLarge = contentWordCount > 50000;
      setIsLargeFile(isLarge);
      
      if (isLarge) {
        logger.log(`Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ù…ÙƒØªØ´Ù: ${contentWordCount} ÙƒÙ„Ù…Ø© - Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…ØªÙˆØ§Ø²ÙŠØ©`);
        progressTracker.updateStageData({ processingMode: 'parallel' });
      }
      
      // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: ØªØ­Ù„ÙŠÙ„ Ø³Ø±ÙŠØ¹
      progressTracker.updateStage('quick_analysis', { stage: 'local_nlp' });
      setProcessingStage("ØªØ­Ù„ÙŠÙ„ Ø£ÙˆÙ„ÙŠ Ù„Ù„Ù†Øµ...");
      const quick = await quickFileAnalysis(rawContent);
      setQuickAnalysis(quick);
      progressTracker.updateProgress(35);
      progressTracker.updateStageData({
        language: quick.language,
        hasChapters: quick.hasChapters,
        chaptersFound: quick.chaptersFound
      });
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…ÙƒØªØ´ÙØ©
      const detectedLang = quick.language || 'ar';
      setFormData(prev => ({
        ...prev,
        title: extractResult.output.title || prev.title,
        author: extractResult.output.author || prev.author,
        language: detectedLang,
        direction: detectedLang === 'en' ? 'ltr' : 'rtl'
      }));
      
      // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ§Ù„ØªÙ†Ø¸ÙŠÙ
      progressTracker.updateStage('chunk_processing', { 
        stage: isLarge ? 'parallel_processing' : 'direct_processing',
        totalWords: contentWordCount
      });
      
      if (isLarge) {
        setProcessingStage(`ØªØ­Ù„ÙŠÙ„ ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ø§Ù„ÙƒØ¨ÙŠØ± (${contentWordCount.toLocaleString('ar')} ÙƒÙ„Ù…Ø©)...`);
      } else {
        setProcessingStage("ØªØ­Ù„ÙŠÙ„ ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ...");
      }
      
      const fullAnalysis = await analyzeAndCleanText(rawContent, detectedLang, logger);
      setAnalysisResults(fullAnalysis);
      progressTracker.updateProgress(75);
      progressTracker.updateStageData({
        cleaned: true,
        finalWordCount: fullAnalysis.final_word_count,
        chaptersDetected: fullAnalysis.chapters?.length || 0
      });
      
      // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
      progressTracker.updateStage('data_preparation', { stage: 'finalizing' });
      setProcessingStage("Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©...");
      setExtractedData({
        title: extractResult.output.title || "",
        author: extractResult.output.author || "",
        content: fullAnalysis.cleaned_text,
        chapters: fullAnalysis.chapters,
        file_url,
        word_count: fullAnalysis.final_word_count,
        page_count: Math.ceil(fullAnalysis.final_word_count / 250),
        original_word_count: fullAnalysis.original_word_count,
        quality_metrics: fullAnalysis.quality_metrics,
        processing_notes: fullAnalysis.processing_notes
      });
      progressTracker.updateProgress(85);
      
      // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù†Ø´Ø± ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
      progressTracker.updateStage('publishing_validation', { stage: 'validating' });
      setProcessingStage("Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù†Ø´Ø±...");
      const manuscriptForValidation = {
        title: extractResult.output.title,
        genre: formData.genre,
        word_count: fullAnalysis.final_word_count,
        chapters: fullAnalysis.chapters,
        quality_metrics: fullAnalysis.quality_metrics
      };
      
      const report = await generatePublishingReport(manuscriptForValidation);
      setPublishingReport(report);
      progressTracker.updateProgress(100);
      progressTracker.updateStageData({
        validated: true,
        qualityScore: report.quality_score,
        passed: report.passed
      });
      
      setProcessing(false);
      setProcessingStage("");
      progressTracker.complete();
      
    } catch (error) {
      progressTracker.error(`Ø®Ø·Ø£: ${error.message}`);
      setProcessing(false);
      setUploading(false);
      setProcessingStage("");
      alert(`Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù: ${error.message}`);
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    const manuscriptData = {
      ...formData,
      content: extractedData?.content || "",
      chapters: extractedData?.chapters || [],
      word_count: extractedData?.word_count || 0,
      page_count: extractedData?.page_count || 0,
      file_url: extractedData?.file_url || "",
      status: "draft",
      compliance_status: "pending"
    };
    
    createManuscriptMutation.mutate(manuscriptData);
  };

  const genres = [
    { value: "Ø±ÙˆØ§ÙŠØ©", label: "Ø±ÙˆØ§ÙŠØ©" },
    { value: "Ù‚ØµØ© Ù‚ØµÙŠØ±Ø©", label: "Ù‚ØµØ© Ù‚ØµÙŠØ±Ø©" },
    { value: "Ø´Ø¹Ø±", label: "Ø´Ø¹Ø±" },
    { value: "Ù…Ù‚Ø§Ù„Ø§Øª", label: "Ù…Ù‚Ø§Ù„Ø§Øª" },
    { value: "Ø¨Ø­Ø« Ø¹Ù„Ù…ÙŠ", label: "Ø¨Ø­Ø« Ø¹Ù„Ù…ÙŠ" },
    { value: "Ø³ÙŠØ±Ø© Ø°Ø§ØªÙŠØ©", label: "Ø³ÙŠØ±Ø© Ø°Ø§ØªÙŠØ©" },
    { value: "ØªØ§Ø±ÙŠØ®", label: "ØªØ§Ø±ÙŠØ®" },
    { value: "Ø¯ÙŠÙ†", label: "Ø¯ÙŠÙ†" },
    { value: "ÙÙ„Ø³ÙØ©", label: "ÙÙ„Ø³ÙØ©" },
    { value: "Ø£Ø®Ø±Ù‰", label: "Ø£Ø®Ø±Ù‰" },
  ];

  return (
    <div className="p-8 max-w-4xl mx-auto">
      <motion.div
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        className="mb-8"
      >
        <Button
          variant="ghost"
          onClick={() => navigate(createPageUrl("Dashboard"))}
          className="mb-4 gap-2"
        >
          <ArrowLeft className="w-4 h-4" />
          Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        </Button>
        <h1 className="text-3xl font-bold text-slate-800">Ø±ÙØ¹ Ù…Ø®Ø·ÙˆØ·Ø© Ø¬Ø¯ÙŠØ¯Ø©</h1>
        <p className="text-slate-500 mt-1">Ù‚Ù… Ø¨Ø±ÙØ¹ Ù…Ù„ÙÙƒ ÙˆØ³Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
      </motion.div>

      {/* Upload Area */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.1 }}
      >
        <Card className="border-0 shadow-lg mb-8">
          <CardContent className="p-8">
            <div
              onDrop={handleFileDrop}
              onDragOver={handleDragOver}
              className={`relative border-2 border-dashed rounded-2xl p-12 text-center transition-all ${
                file
                  ? "border-emerald-400 bg-emerald-50"
                  : "border-slate-300 hover:border-[#2563eb] hover:bg-blue-50/30"
              }`}
            >
              <input
                type="file"
                accept=".txt,.html,.docx"
                onChange={handleFileDrop}
                className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
              />
              
              <AnimatePresence mode="wait">
                {uploading || processing ? (
                  <motion.div
                    key="uploading"
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    exit={{ opacity: 0 }}
                    className="space-y-4"
                  >
                    <Loader2 className="w-16 h-16 text-[#2563eb] mx-auto animate-spin" />
                    <p className="text-lg font-medium text-slate-700">
                      {processingStage || (uploading ? "Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù..." : "Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰...")}
                    </p>
                    {uploading && (
                      <Progress value={uploadProgress} className="w-64 mx-auto" />
                    )}
                    {processing && (
                      <div className="text-sm text-slate-500 max-w-md mx-auto">
                        <p>Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù‚Ø¯ ØªØ³ØªØºØ±Ù‚ Ø¹Ø¯Ø© Ø¯Ù‚Ø§Ø¦Ù‚ Ù„Ù„Ù†ØµÙˆØµ Ø§Ù„ÙƒØ¨ÙŠØ±Ø©...</p>
                      </div>
                    )}
                  </motion.div>
                ) : file ? (
                  <motion.div
                    key="uploaded"
                    initial={{ opacity: 0, scale: 0.9 }}
                    animate={{ opacity: 1, scale: 1 }}
                    exit={{ opacity: 0 }}
                    className="space-y-4"
                  >
                    <div className="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto">
                      <Check className="w-8 h-8 text-emerald-600" />
                    </div>
                    <div>
                      <p className="text-lg font-medium text-slate-700">{file.name}</p>
                      <p className="text-sm text-slate-500">
                        {(file.size / 1024 / 1024).toFixed(2)} MB
                      </p>
                    </div>
                    <div className="flex items-center justify-center gap-4">
                      <Button
                        variant="outline"
                        onClick={(e) => {
                          e.stopPropagation();
                          setFile(null);
                          setExtractedData(null);
                        }}
                        className="gap-2"
                      >
                        <X className="w-4 h-4" />
                        Ø¥Ø²Ø§Ù„Ø©
                      </Button>
                      {!extractedData && (
                        <Button
                          onClick={(e) => {
                            e.stopPropagation();
                            processFile();
                          }}
                          className="gap-2 bg-gradient-to-l from-[#1e3a5f] to-[#2563eb]"
                        >
                          <Sparkles className="w-4 h-4" />
                          ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
                        </Button>
                      )}
                    </div>
                  </motion.div>
                ) : (
                  <motion.div
                    key="empty"
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    exit={{ opacity: 0 }}
                    className="space-y-4"
                  >
                    <div className="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto">
                      <UploadIcon className="w-10 h-10 text-slate-400" />
                    </div>
                    <div>
                      <p className="text-lg font-medium text-slate-700">
                        Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„ØªØ­Ù…ÙŠÙ„
                      </p>
                      <p className="text-sm text-slate-500 mt-1">
                        ÙŠØ¯Ø¹Ù… TXT, HTML, DOCX ÙÙ‚Ø· | Ø­Ø¯ Ø£Ù‚ØµÙ‰ 7 MB
                      </p>
                      <p className="text-xs text-slate-400 mt-2">
                        Ø§Ù„Ù‚Ø¯Ø±Ø© Ø¹Ù„Ù‰ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­ØªÙ‰ 200,000 ÙƒÙ„Ù…Ø©
                      </p>
                    </div>
                  </motion.div>
                )}
              </AnimatePresence>
            </div>
          </CardContent>
        </Card>
        
        {/* File Validation Alert */}
        {fileValidation && (
          <motion.div
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            className="mt-4"
          >
            <FileValidationAlert validation={fileValidation} />
          </motion.div>
        )}
        
        {/* Live Progress Indicator */}
        {(uploading || processing) && (
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="mt-6"
          >
            <LiveProgressIndicator
              currentStage={progressTracker.currentStage}
              progress={progressTracker.progress}
              stageData={progressTracker.stageData}
              isComplete={progressTracker.isComplete}
              hasError={progressTracker.hasError}
              errorMessage={progressTracker.errorMessage}
              elapsedTime={progressTracker.elapsedTime}
              estimatedTime={progressTracker.estimatedTime}
            />
          </motion.div>
        )}
      </motion.div>

      {/* Quick Analysis Results */}
      {quickAnalysis && !extractedData && (
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
        >
          <Card className="border-0 shadow-lg mb-8 bg-gradient-to-br from-purple-50 to-pink-50">
            <CardContent className="p-6">
              <div className="flex items-center gap-3 mb-4">
                <CheckCircle2 className="w-5 h-5 text-purple-600" />
                <h3 className="font-semibold text-slate-800">Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ</h3>
              </div>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div className="bg-white/60 rounded-xl p-4">
                  <p className="text-sm text-slate-500">Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</p>
                  <p className="text-2xl font-bold text-slate-800">
                    {quickAnalysis.word_count?.toLocaleString()}
                  </p>
                </div>
                <div className="bg-white/60 rounded-xl p-4">
                  <p className="text-sm text-slate-500">Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…ÙƒØªØ´ÙØ©</p>
                  <p className="text-lg font-bold text-slate-800">
                    {quickAnalysis.language === 'ar' ? 'Ø¹Ø±Ø¨ÙŠ' : quickAnalysis.language === 'en' ? 'Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ' : 'Ù…Ø®ØªÙ„Ø·'}
                  </p>
                </div>
                <div className="bg-white/60 rounded-xl p-4">
                  <p className="text-sm text-slate-500">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</p>
                  <p className="text-sm font-bold text-slate-800">
                    {quickAnalysis.content_type}
                  </p>
                </div>
                <div className="bg-white/60 rounded-xl p-4">
                  <p className="text-sm text-slate-500">Ø¬ÙˆØ¯Ø© Ù…Ù‚Ø¯Ø±Ø©</p>
                  <p className="text-sm font-bold text-slate-800">
                    {quickAnalysis.estimated_quality === 'high' ? 'Ø¹Ø§Ù„ÙŠØ©' : quickAnalysis.estimated_quality === 'medium' ? 'Ù…ØªÙˆØ³Ø·Ø©' : 'Ù…Ù†Ø®ÙØ¶Ø©'}
                  </p>
                </div>
              </div>
            </CardContent>
          </Card>
        </motion.div>
      )}

      {/* Extracted Info */}
      {extractedData && (
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
        >
          <Card className="border-0 shadow-lg mb-8 bg-gradient-to-br from-blue-50 to-indigo-50">
            <CardContent className="p-6">
              <div className="flex items-center gap-3 mb-4">
                <Sparkles className="w-5 h-5 text-[#c9a227]" />
                <h3 className="font-semibold text-slate-800">ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø·ÙˆØ·Ø©</h3>
              </div>
              <div className="space-y-4">
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className="bg-white/60 rounded-xl p-4">
                    <p className="text-sm text-slate-500">Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª (Ù†Ù‡Ø§Ø¦ÙŠ)</p>
                    <p className="text-2xl font-bold text-slate-800">
                      {extractedData.word_count?.toLocaleString()}
                    </p>
                    {extractedData.original_word_count && extractedData.original_word_count !== extractedData.word_count && (
                      <p className="text-xs text-slate-400 mt-1">
                        Ø§Ù„Ø£ØµÙ„ÙŠ: {extractedData.original_word_count?.toLocaleString()}
                      </p>
                    )}
                  </div>
                  <div className="bg-white/60 rounded-xl p-4">
                    <p className="text-sm text-slate-500">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª</p>
                    <p className="text-2xl font-bold text-slate-800">
                      {extractedData.page_count}
                    </p>
                  </div>
                  <div className="bg-white/60 rounded-xl p-4">
                    <p className="text-sm text-slate-500">Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„</p>
                    <p className="text-2xl font-bold text-slate-800">
                      {extractedData.chapters?.length || 0}
                    </p>
                  </div>
                  <div className="bg-white/60 rounded-xl p-4">
                    <p className="text-sm text-slate-500">Ø§Ù„Ø­Ø§Ù„Ø©</p>
                    <p className="text-lg font-bold text-emerald-600">âœ“ Ù…Ø¹Ø§Ù„Ø¬</p>
                  </div>
                </div>
                
                {analysisResults && (
                  <div className="bg-white/80 rounded-xl p-4">
                    <h4 className="font-semibold text-sm text-slate-700 mb-3">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</h4>
                    <div className="space-y-2 text-xs text-slate-600">
                      {analysisResults.processing_notes?.structural_elements_removed?.length > 0 && (
                        <p>
                          âœ“ ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‡ÙŠÙƒÙ„ÙŠØ©: {analysisResults.processing_notes.structural_elements_removed.join(', ')}
                        </p>
                      )}
                      {analysisResults.compensation_applied && (
                        <p className="text-amber-600">
                          âš  ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ØªØ¹ÙˆÙŠØ¶ Ù„Ù„Ù…Ø­ØªÙˆÙ‰ (ÙØ±Ù‚: {analysisResults.difference_percentage?.toFixed(1)}%)
                        </p>
                      )}
                      {analysisResults.quality_metrics && (
                        <div className="grid grid-cols-3 gap-2 mt-2">
                          <div>
                            <p className="text-slate-400">Ø§Ù„ØªÙƒØ±Ø§Ø±</p>
                            <p className="font-medium">{analysisResults.quality_metrics.repetition_rate?.toFixed(0)}%</p>
                          </div>
                          <div>
                            <p className="text-slate-400">Ø§Ù„ØªÙ†Ø§Ø³Ù‚ Ø§Ù„Ù„ØºÙˆÙŠ</p>
                            <p className="font-medium">{analysisResults.quality_metrics.language_consistency?.toFixed(0)}%</p>
                          </div>
                          <div>
                            <p className="text-slate-400">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ÙŠØ©</p>
                            <p className="font-medium">{analysisResults.quality_metrics.thematic_unity?.toFixed(0)}%</p>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                )}
                
                {publishingReport && (
                  <div className="mt-4 bg-white/80 rounded-xl p-4 border-r-4" style={{
                    borderColor: publishingReport.passed ? '#10b981' : publishingReport.issues.length > 0 ? '#ef4444' : '#f59e0b'
                  }}>
                    <h4 className="font-semibold text-sm text-slate-700 mb-3 flex items-center gap-2">
                      {publishingReport.passed ? (
                        <CheckCircle2 className="w-4 h-4 text-emerald-600" />
                      ) : (
                        <AlertCircle className="w-4 h-4 text-amber-600" />
                      )}
                      ØªÙ‚Ø±ÙŠØ± Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù†Ø´Ø± (Ø§Ù„Ø¬ÙˆØ¯Ø©: {publishingReport.quality_score}/100)
                    </h4>
                    
                    {publishingReport.issues.length > 0 && (
                      <div className="mb-3">
                        <p className="text-xs font-semibold text-red-700 mb-1">âš  Ù…Ø´Ø§ÙƒÙ„ Ø­Ø±Ø¬Ø©:</p>
                        <ul className="text-xs text-red-600 list-disc list-inside space-y-1">
                          {publishingReport.issues.map((issue, i) => (
                            <li key={i}>{issue}</li>
                          ))}
                        </ul>
                      </div>
                    )}
                    
                    {publishingReport.warnings.length > 0 && (
                      <div className="mb-3">
                        <p className="text-xs font-semibold text-amber-700 mb-1">âš  ØªØ­Ø°ÙŠØ±Ø§Øª:</p>
                        <ul className="text-xs text-amber-600 list-disc list-inside space-y-1">
                          {publishingReport.warnings.map((warning, i) => (
                            <li key={i}>{warning}</li>
                          ))}
                        </ul>
                      </div>
                    )}
                    
                    {publishingReport.recommendations.length > 0 && (
                      <div>
                        <p className="text-xs font-semibold text-blue-700 mb-1">ğŸ’¡ ØªÙˆØµÙŠØ§Øª:</p>
                        <ul className="text-xs text-blue-600 list-disc list-inside space-y-1">
                          {publishingReport.recommendations.map((rec, i) => (
                            <li key={i}>{rec}</li>
                          ))}
                        </ul>
                      </div>
                    )}
                    
                    {publishingReport.professional_assessment && (
                      <div className="mt-3 pt-3 border-t border-slate-200">
                        <p className="text-xs font-semibold text-slate-700 mb-2">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ù‡Ù†ÙŠ:</p>
                        <p className="text-xs text-slate-600 whitespace-pre-line">
                          {publishingReport.professional_assessment}
                        </p>
                      </div>
                    )}
                  </div>
                )}
              </div>
            </CardContent>
          </Card>
        </motion.div>
      )}

      {/* Form */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.2 }}
      >
        <Card className="border-0 shadow-lg">
          <CardHeader>
            <CardTitle>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø®Ø·ÙˆØ·Ø©</CardTitle>
          </CardHeader>
          <CardContent>
            <form onSubmit={handleSubmit} className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="space-y-2">
                  <Label htmlFor="title" className="flex items-center gap-2">
                    <BookOpen className="w-4 h-4" />
                    Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø®Ø·ÙˆØ·Ø©
                  </Label>
                  <Input
                    id="title"
                    value={formData.title}
                    onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                    placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø®Ø·ÙˆØ·Ø©"
                    required
                  />
                </div>
                
                <div className="space-y-2">
                  <Label htmlFor="author" className="flex items-center gap-2">
                    <User className="w-4 h-4" />
                    Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ù„Ù
                  </Label>
                  <Input
                    id="author"
                    value={formData.author}
                    onChange={(e) => setFormData({ ...formData, author: e.target.value })}
                    placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ù„Ù"
                    required
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="genre" className="flex items-center gap-2">
                    <Tag className="w-4 h-4" />
                    Ø§Ù„ØªØµÙ†ÙŠÙ
                  </Label>
                  <Select
                    value={formData.genre}
                    onValueChange={(value) => setFormData({ ...formData, genre: value })}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ" />
                    </SelectTrigger>
                    <SelectContent>
                      {genres.map((genre) => (
                        <SelectItem key={genre.value} value={genre.value}>
                          {genre.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label htmlFor="language" className="flex items-center gap-2">
                    <Globe className="w-4 h-4" />
                    Ø§Ù„Ù„ØºØ©
                  </Label>
                  <Select
                    value={formData.language}
                    onValueChange={(value) => setFormData({ 
                      ...formData, 
                      language: value,
                      direction: value === "en" ? "ltr" : "rtl"
                    })}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</SelectItem>
                      <SelectItem value="en">English</SelectItem>
                      <SelectItem value="mixed">Ù…Ø®ØªÙ„Ø·Ø©</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>

              <div className="flex justify-end gap-4 pt-4">
                <Button
                  type="button"
                  variant="outline"
                  onClick={() => navigate(createPageUrl("Dashboard"))}
                >
                  Ø¥Ù„ØºØ§Ø¡
                </Button>
                <Button
                  type="submit"
                  disabled={!formData.title || !formData.author || createManuscriptMutation.isPending}
                  className="bg-gradient-to-l from-[#1e3a5f] to-[#2563eb] gap-2"
                >
                  {createManuscriptMutation.isPending ? (
                    <Loader2 className="w-4 h-4 animate-spin" />
                  ) : (
                    <Check className="w-4 h-4" />
                  )}
                  Ø­ÙØ¸ Ø§Ù„Ù…Ø®Ø·ÙˆØ·Ø©
                </Button>
              </div>
            </form>
          </CardContent>
        </Card>
      </motion.div>
    </div>
  );
}